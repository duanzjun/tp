<include file="Public:header" />
<div class="container-fluid">
    <div class="row">
        <include file="Public:sidebar" />
        <div class="col-main">
            <div class="row d-nav">
                <ul class="nav nav-tabs" role="tablist">
                    <li class="active"><a href="#">分类管理</a></li>
                    <li><a href="{:U('category/add')}">添加分类</a></li>
                </ul>
            </div>
            <div class="row">
                <a href="#" class="delall">批量删除</a>
            </div>
            <div class="row">
                <table class="table table-hover">
                <thead>
                <tr>
                    <th><input id="checkedall" class="checkedall" type="checkbox" /></th>
                    <th>分类名称</th>
                    <th>显示</th>
                    <th width="150">排序</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody>
                    {$html_tree}
                </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
$(function(){
    $('.is_visibility').on('click',function(){
        var dId = $(this).parent().parent('tr').attr('d-id');
        var that = $(this);
        var s_val = $(this).attr('data-val') == 1  ? 0 : 1;
        $.getJSON('index.php?c=articlecategory&a=ajax_edit',{'id':dId,'field':'visibility','val':s_val},function(data){
                if(data.status==true){
                    if(data.rel.visibility==1)
                        that.children('i').attr('class','glyphicon glyphicon-ok');
                    else
                        that.children('i').attr('class','glyphicon glyphicon-remove');
                    that.attr('data-val',s_val);
                }else
                    alert('操作失败！');
        });
    });
    $('.is_sort').on('click',function(){
        var dId = $(this).parent().parent('tr').attr('d-id');
        var s_val = $(this).text();
        $('<input type="text" class="lt_input_text" value="'+s_val+'" />').width(35).focusout(function(){
            $(this).prev('span').show().text($(this).val());
            if($(this).val() != s_val) {
                $.getJSON('index.php?c=articlecategory&a=ajax_edit',{'id':dId,'field':'sort','val':$(this).val()},function(data){
                    if(data.status!=true)
                        alert('操作失败！');
                });
            }
            $(this).remove();
        }).insertAfter($(this)).focus().select();
        $(this).hide();
        return false;
    });

    $('.table').on('click','[data-target=#delModal]',function(){
        $('#delModal .modal-dialog').css('width','220');
        var that=$(this);
        $('#delcontent').on('click',function(){
            $.get(that.attr('data-uri'),function(data){
                $('#delModal').modal('hide');
                if(data===true){
                    that.parent().parent().fadeOut('slow',function(){
                        $(this).remove();
                    });
                }else
                    alert('删除失败！');
            });
        });
    });
    $('.checkedall').on('click',function(){
        $('input[name=checkedid]:checkbox').prop("checked",this.checked);
    });
    $('.delall').on('click',function(){
        var arr=new Array();
        $('input[name=checkedid]:checkbox:checked').each(function(){
            arr.push($(this).val());
        })
        if(arr.length<=0){
            alert('你没有选中删除项');
            return false;
        }
        if(!confirm('你确定删除吗？'))
            return false;
        $.get('index.php?c=articlecategory&a=del',{'id':arr.join(',')},function(data){
            if(data===true){
                $('input[name=checkedid]:checkbox:checked').each(function(){
                    $(this).parent().parent('tr').fadeOut('slow',function(){
                        $(this).remove();
                    });
                })
            }else
                alert('删除失败！');
        });
    });
    $('input[name=checkedid]:checkbox').on('click',function(){
        var tmp=$('input[name=checkedid]:checkbox');
        $('.checkedall').prop('checked',tmp.length==tmp.filter(':checked').length);
    });
});
</script>
<!-- delModal -->
<div class="modal fade" id="delModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">关闭</span></button>
        <h4 class="modal-title" id="myModalLabel">消息提示</h4>
      </div>
      <div class="modal-body">确认删除吗？</div>
      <div class="modal-footer">
        <!-- <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button> -->
        <button class="btn btn-primary" id="delcontent" type="button">确定</button>
      </div>
    </div>
  </div>
</div>
<include file="Public:footer" />